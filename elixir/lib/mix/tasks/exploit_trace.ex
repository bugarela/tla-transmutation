defmodule Mix.Tasks.ExploitTrace do
  @moduledoc "Runs blackblox testing using the oracle"
  @shortdoc "Runs trace checking for a witness"
  use Mix.Task

  @impl Mix.Task
  def run(_) do
    trace =  [
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 0, "tag" => "None" },
  next_tx_id: 0,
  pending_transactions: MapSet.new([])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 0, "tag" => "None" },
  next_tx_id: 1,
  pending_transactions: MapSet.new([%{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 0, "tag" => "None" },
  next_tx_id: 2,
  pending_transactions: MapSet.new([%{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 1, "sender" => "Alice_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 0, "tag" => "None" },
  next_tx_id: 3,
  pending_transactions: MapSet.new([%{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 1, "sender" => "Alice_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 2, "sender" => "Bob_OF_ADDR", "tag" => "transfer", "toAddr" => "Alice_OF_ADDR", "value" => 0 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 1, "sender" => "Alice_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 },
  next_tx_id: 3,
  pending_transactions: MapSet.new([%{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 2, "sender" => "Bob_OF_ADDR", "tag" => "transfer", "toAddr" => "Alice_OF_ADDR", "value" => 0 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 0, "tag" => "None" },
  next_tx_id: 4,
  pending_transactions: MapSet.new([%{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 2, "sender" => "Bob_OF_ADDR", "tag" => "transfer", "toAddr" => "Alice_OF_ADDR", "value" => 0 }, %{ "fail" => false, "id" => 3, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 3 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 2, "sender" => "Bob_OF_ADDR", "tag" => "transfer", "toAddr" => "Alice_OF_ADDR", "value" => 0 },
  next_tx_id: 4,
  pending_transactions: MapSet.new([%{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 3, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 3 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 0, "tag" => "None" },
  next_tx_id: 5,
  pending_transactions: MapSet.new([%{ "fail" => false, "fromAddr" => "Eve_OF_ADDR", "id" => 4, "sender" => "Bob_OF_ADDR", "tag" => "transferFrom", "toAddr" => "Alice_OF_ADDR", "value" => 2 }, %{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 3, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 3 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 0, "tag" => "None" },
  next_tx_id: 6,
  pending_transactions: MapSet.new([%{ "fail" => false, "fromAddr" => "Eve_OF_ADDR", "id" => 4, "sender" => "Bob_OF_ADDR", "tag" => "transferFrom", "toAddr" => "Alice_OF_ADDR", "value" => 2 }, %{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 3, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 3 }, %{ "fail" => false, "id" => 5, "sender" => "Alice_OF_ADDR", "tag" => "transfer", "toAddr" => "Eve_OF_ADDR", "value" => 0 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 3, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 100, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 100 },
  last_tx: %{ "fail" => false, "id" => 3, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 3 },
  next_tx_id: 6,
  pending_transactions: MapSet.new([%{ "fail" => false, "fromAddr" => "Eve_OF_ADDR", "id" => 4, "sender" => "Bob_OF_ADDR", "tag" => "transferFrom", "toAddr" => "Alice_OF_ADDR", "value" => 2 }, %{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 5, "sender" => "Alice_OF_ADDR", "tag" => "transfer", "toAddr" => "Eve_OF_ADDR", "value" => 0 }])
},
%{
  allowance: %{ {"Bob_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Alice_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Alice_OF_ADDR", "Eve_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Bob_OF_ADDR"} => 0, {"Bob_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Alice_OF_ADDR"} => 0, {"Eve_OF_ADDR", "Bob_OF_ADDR"} => 1, {"Eve_OF_ADDR", "Eve_OF_ADDR"} => 0 },
  balance_of: %{ "Alice_OF_ADDR" => 102, "Bob_OF_ADDR" => 100, "Eve_OF_ADDR" => 98 },
  last_tx: %{ "fail" => false, "fromAddr" => "Eve_OF_ADDR", "id" => 4, "sender" => "Bob_OF_ADDR", "tag" => "transferFrom", "toAddr" => "Alice_OF_ADDR", "value" => 2 },
  next_tx_id: 6,
  pending_transactions: MapSet.new([%{ "fail" => false, "id" => 0, "sender" => "Eve_OF_ADDR", "spender" => "Bob_OF_ADDR", "tag" => "approve", "value" => 1 }, %{ "fail" => false, "id" => 5, "sender" => "Alice_OF_ADDR", "tag" => "transfer", "toAddr" => "Eve_OF_ADDR", "value" => 0 }])
}
    ]

    modules =  [
        ERC20_alice,
      ERC20_bob,
      ERC20_eve,
      ERC20_blockchain
    ]
    pids = Enum.map(modules, fn m -> spawn(m, :main, [self(), Enum.at(trace, 0), 0]) end)
    TraceCheckerOracle.start(trace, 0, nil, pids)
  end
end
